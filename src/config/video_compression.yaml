# Video Compression Configuration (packaged defaults)
video_compression:
  # General settings
  max_file_size_mb: 10
  # temp_dir is ignored as of v0.1.2; temp is fixed at <package_root>/temp
  temp_dir: "./temp"

  # Hardware acceleration settings
  hardware_acceleration:
    nvidia: "h264_nvenc"
    amd: "h264_amf"
    fallback: "libx264"

  # Video segmentation settings - LAST RESORT only
  segmentation:
    # Enable watchdog timeout to prevent hanging ffmpeg segment encodes
    enable_timeout: true
    # Size-based thresholds (primary decision factors) - More conservative for 2-3min videos
    size_threshold_multiplier: 3.0 # Split if estimated size > 3.0x target (increased from 2.5)
    fallback_duration_limit: 300 # Split extremely long videos (5 minutes, reduced from 10 for longer segments)
    # Prefer single file; segment only as last resort
    only_if_single_file_unacceptable: true

    # Segment duration preferences
    min_segment_duration: 45 # Minimum 30 seconds per segment (increased from 15)
    max_segment_duration: 240 # Maximum 4 minutes per segment (increased from 2)

    # Base durations by video length
    base_durations:
      short_video_max: 90 # Videos up to 1 minute
      short_segment_duration: 60 # 45-second segments (increased from 30)
      medium_video_max: 180 # Videos up to 3 minutes
      medium_segment_duration: 120 # 120-second segments (increased from 90 to favor 2 segments)
      long_video_max: 600 # Videos up to 10 minutes
      long_segment_duration: 120 # 2-minute segments (increased from 60)
      very_long_segment_duration: 180 # 3-minute segments (increased from 90)

    # Quality adjustments for longer segments
    quality_scaling:
      enabled: true
      long_segment_fps_reduction: 0.9 # Reduce FPS for longer segments
      long_segment_quality_reduction: 0.95 # Slightly reduce quality for longer segments

    # Size estimation parameters
    estimation:
      # Parameters used for initial size estimation
      default_fps: 30
      default_bitrate: "1000k"
      default_crf: 28

      # Aggressive compression test parameters
      aggressive_fps: 24
      aggressive_bitrate: "700k"
      aggressive_crf: 30
    # Finalization policy
    reject_oversize_on_finalize: true
    adapt_resolution: true

    # Concurrency settings for parallel processing
    max_concurrent_segments: 4  # Max segments to process in parallel
    max_concurrent_ffmpeg_processes: 2  # Max ffmpeg processes for segment creation
    max_concurrent_optimizations: 1  # Max concurrent segment optimizations

  # Social media platform presets
  platforms:
    instagram:
      max_width: 1080
      max_height: 1080
      aspect_ratio: "1:1"
      bitrate: "1000k"
      fps: 30

    twitter:
      max_width: 1280
      max_height: 720
      aspect_ratio: "16:9"
      bitrate: "1200k"
      fps: 30

    tiktok:
      max_width: 1080
      max_height: 1920
      aspect_ratio: "9:16"
      bitrate: "1500k"
      fps: 30

    youtube_shorts:
      max_width: 1080
      max_height: 1920
      aspect_ratio: "9:16"
      bitrate: "2000k"
      fps: 30

    facebook:
      max_width: 1280
      max_height: 720
      aspect_ratio: "16:9"
      bitrate: "1000k"
      fps: 30

    discord:
      max_width: 1920
      max_height: 1080
      aspect_ratio: "16:9"
      bitrate: "1000k"
      fps: 30
      max_file_size_mb: 10 # Discord's 10MB limit for free users

  # Quality settings
  quality:
    crf: 24 # Constant Rate Factor (lower = higher quality)
    preset: "slower" # ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow
    tune: "film" # film, animation, grain, stillimage, fastdecode, zerolatency

  # Advanced codec and quality controls
  codec:
    allow_hevc: true
    allow_h264_high10: true
    priority: [hevc_10bit, hevc_8bit, h264_10bit, h264_8bit]
    final_preset: medium
    tune: animation
    min_bpp:
      h264_8bit: 0.023
      h264_10bit: 0.020
      hevc_8bit: 0.018
      hevc_10bit: 0.015

  fps_policy:
    prefer_24fps_for_low_motion: true
    low_motion_threshold: 0.35

  prefilters:
    denoise: true
    deband: true

  quality_controls:
    min_target_utilization: 0.92
    refine_iterations: 2
    hybrid_quality_check:
      enabled: true
      single_file_floor: 65  # Out of 100 - reasonable quality for single compressed files
      segment_floors: [70, 60, 50, 45]  # Progressive fallback for segments: higher quality expected, but fallback if needed
      weights:
        perceptual_hash: 0.40  # Human-perceivable similarity (most important)
        size_efficiency: 0.20  # How well target size was utilized
        frame_validity: 0.20   # Frames can be decoded without corruption
        technical_validity: 0.20  # Format integrity, duration accuracy
      sampling:
        key_frames: 5  # start, 25%, 50%, 75%, end
        random_frames: 3  # Additional random samples for validation
    uplift:
      enabled: true
      max_passes: 3
      bitrate_step: 1.12
      max_multiplier: 1.35
    on_fail_segment: true
  # Strict size enforcement and near-limit retry
  size_control:
    near_limit_retry_percent: 0.08
  # Segmentation finalize policy (merge into top segmentation block)
