# Video Compression Configuration (packaged defaults)
video_compression:
  # General settings
  # Theoretical limits: max_file_size_mb > 0 (practical: 1MB-100MB for most platforms)
  max_file_size_mb: 10
  # temp_dir is ignored as of v0.1.2; temp is fixed at <package_root>/temp
  temp_dir: "./temp"

  # Hardware acceleration settings
  # Theoretical limits: encoder names must match FFmpeg encoder names (h264_nvenc, h264_amf, libx264, libx265, etc.)
  hardware_acceleration:
    nvidia: "h264_nvenc"
    amd: "h264_amf"
    fallback: "libx264"

  # Bitrate validation settings
  # Theoretical limits: encoder_minimums (kbps) >= 1, min_resolution width/height >= 64 (H.264 minimum), min_fps >= 1, fps_reduction_steps (0.0-1.0)
  bitrate_validation:
    enabled: true
    # Minimum bitrate requirements per encoder (in kbps)
    encoder_minimums:
      libx264: 10 # FFmpeg libx264 minimum (raised for better audio quality)
      libx265: 15 # HEVC requires higher minimum (raised for better audio quality)
      h264_nvenc: 8 # NVENC minimum (raised for better audio quality)
      h264_amf: 8 # AMD AMF minimum (raised for better audio quality)
      h264_qsv: 8 # Intel QSV minimum (raised for better audio quality)
      h264_videotoolbox: 8 # Apple VideoToolbox minimum (raised for better audio quality)
    # Fallback resolutions for extreme compression scenarios
    fallback_resolutions:
      - [1280, 720] # Enforce 720p minimum outputs
    # Auto-segment threshold - files larger than this will be considered for segmentation
    segmentation_threshold_mb: 50
    # Safety margin for bitrate calculations (multiplier)
    safety_margin: 1.1
    # Minimum resolution constraints
    min_resolution:
      width: 1280
      height: 720
    # Minimum FPS constraint
    min_fps: 20
    guardrail_override:
      enabled: true
      bpp_ratio_threshold: 0.7
      min_resolution:
        width: 640
        height: 360
      min_fps: 12
    # FPS reduction steps (as ratios of original FPS)
    fps_reduction_steps: [0.8, 0.6, 0.5]
    # Prefer quality/resolution reduction over aggressive FPS reduction
    prefer_quality_over_fps: true

  # Video segmentation settings - LAST RESORT only
  # Theoretical limits: min_segment_duration >= 1s, max_segment_duration >= min_segment_duration, max_concurrent_segments >= 1, multipliers (0.0-1.0)
  segmentation:
    # Enable watchdog timeout to prevent hanging ffmpeg segment encodes
    enable_timeout: true
    # Size-based thresholds (primary decision factors) - More conservative for 2-3min videos
    size_threshold_multiplier: 3.0 # Split if estimated size > 3.0x target (increased from 2.5)
    fallback_duration_limit: 300 # Split extremely long videos (5 minutes, reduced from 10 for longer segments)
    # Prefer single file; segment only as last resort
    only_if_single_file_unacceptable: true

    # Segment duration preferences
    min_segment_duration: 45 # Minimum 30 seconds per segment (increased from 15)
    max_segment_duration: 240 # Maximum 4 minutes per segment (increased from 2)

    # Base durations by video length
    base_durations:
      short_video_max: 90 # Videos up to 1 minute
      short_segment_duration: 60 # 45-second segments (increased from 30)
      medium_video_max: 180 # Videos up to 3 minutes
      medium_segment_duration: 120 # 120-second segments (increased from 90 to favor 2 segments)
      long_video_max: 600 # Videos up to 10 minutes
      long_segment_duration: 120 # 2-minute segments (increased from 60)
      very_long_segment_duration: 180 # 3-minute segments (increased from 90)

    # Quality adjustments for longer segments
    quality_scaling:
      enabled: true
      long_segment_fps_reduction: 0.9 # Reduce FPS for longer segments
      long_segment_quality_reduction: 0.95 # Slightly reduce quality for longer segments

    # Size estimation parameters
    estimation:
      # Parameters used for initial size estimation
      default_fps: 30
      default_bitrate: "1000k"
      default_crf: 28

      # Aggressive compression test parameters
      aggressive_fps: 24
      aggressive_bitrate: "700k"
      aggressive_crf: 30
    # Finalization policy
    reject_oversize_on_finalize: true
    adapt_resolution: true

    # Concurrency settings for parallel processing
    max_concurrent_segments: 4 # Max segments to process in parallel
    max_concurrent_ffmpeg_processes: 2 # Max ffmpeg processes for segment creation
    max_concurrent_optimizations: 1 # Max concurrent segment optimizations

  # Social media platform presets
  # Theoretical limits: max_width/height >= 64 (H.264 minimum), bitrate (kbps) >= encoder minimum, fps >= 1, aspect_ratio must be valid ratio string
  platforms:
    instagram:
      max_width: 1080
      max_height: 1080
      aspect_ratio: "1:1"
      bitrate: "1000k"
      fps: 30

    twitter:
      max_width: 1280
      max_height: 720
      aspect_ratio: "16:9"
      bitrate: "1200k"
      fps: 30

    tiktok:
      max_width: 1080
      max_height: 1920
      aspect_ratio: "9:16"
      bitrate: "1500k"
      fps: 30

    youtube_shorts:
      max_width: 1080
      max_height: 1920
      aspect_ratio: "9:16"
      bitrate: "2000k"
      fps: 30

    facebook:
      max_width: 1280
      max_height: 720
      aspect_ratio: "16:9"
      bitrate: "1000k"
      fps: 30

    discord:
      max_width: 1920
      max_height: 1080
      aspect_ratio: "16:9"
      bitrate: "1000k"
      fps: 30
      max_file_size_mb: 10 # Discord's 10MB limit for free users

  # Quality settings
  # Theoretical limits: crf (0-51, lower=better quality), preset (ultrafast|superfast|veryfast|faster|fast|medium|slow|slower|veryslow), tune (film|animation|grain|stillimage|fastdecode|zerolatency)
  quality:
    crf: 24 # Constant Rate Factor (lower = higher quality)
    preset: "slower" # ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow
    tune: "film" # film, animation, grain, stillimage, fastdecode, zerolatency

  # Quality evaluation settings
  # Theoretical limits: confidence_thresholds (0.0-1.0), timeout_seconds >= 1, retry_attempts >= 0, thresholds (0.0-100.0), weights sum should be ~1.0
  quality_evaluation:
    fallback_mode: "conservative" # 'conservative', 'permissive', 'strict'
    confidence_thresholds:
      minimum_acceptable: 0.3 # Minimum confidence to trust evaluation results
      high_confidence: 0.8 # Threshold for high confidence results
      decision_threshold: 0.5 # Threshold for making quality decisions

    # FFmpeg execution configuration
    ffmpeg_execution:
      timeout_seconds: 300 # Default timeout for FFmpeg operations
      retry_attempts: 3 # Number of retry attempts for failed operations
      retry_delay_seconds: 2 # Delay between retry attempts
      enable_detailed_errors: true # Enable detailed error analysis and logging
      capture_performance_metrics: false # Log performance metrics for operations

    # SSIM parsing configuration
    ssim_parsing:
      timeout_seconds: 300 # Timeout for SSIM computation
      retry_attempts: 3 # Number of retry attempts for parsing
      alternative_formats: true # Enable alternative parsing strategies
      validation:
        enable_outlier_detection: true # Enable statistical outlier detection
        min_samples_for_outlier_detection: 4 # Minimum samples needed for outlier detection
        iqr_multiplier: 1.5 # IQR multiplier for outlier bounds

    # VMAF parsing configuration
    vmaf_parsing:
      timeout_seconds: 300 # Timeout for VMAF computation
      json_fallback: true # Enable JSON format fallback
      prefer_json_format: true # Try JSON format first
      text_parsing_patterns: # Custom regex patterns for text parsing
        - 'VMAF\s+score[:\s]+([\d.]+)'
        - 'vmaf[:\s]+([\d.]+)'
        - 'mean[:\s]+([\d.]+)'

    # Error handling and debugging
    error_handling:
      continue_on_parse_failure: true # Continue processing when parsing fails
      log_parsing_details: false # Enable detailed parsing logs for debugging
      default_pass_on_failure: false # Whether to pass quality gates when evaluation fails
      create_diagnostic_files: false # Create diagnostic files for failed evaluations
      diagnostic_output_dir: "./logs/quality_diagnostics" # Directory for diagnostic files

    # Debug file management
    debug_files:
      cleanup_enabled: true # Enable automatic cleanup of debug files
      retention_policy: "immediate" # 'immediate', 'session', 'daily', 'weekly'
      max_files_per_session: 10 # Maximum debug files to keep per session
      max_age_hours: 24 # Maximum age of debug files in hours (for time-based retention)
      cleanup_on_success: true # Clean up debug files when operation succeeds
      cleanup_on_failure: false # Keep debug files when operation fails for troubleshooting

    # Logging configuration
    logging:
      enable_structured_logging: true # Enable structured logging for quality evaluation
      log_performance_metrics: false # Log detailed performance metrics
      log_parsing_attempts: false # Log individual parsing attempts (debug level)
      log_confidence_breakdown: true # Log confidence score breakdown

    # Performance optimization settings
    performance_optimization:
      enable_prediction: true # Enable quality result prediction
      enable_frequency_limits: true # Enable evaluation frequency limits
      enable_time_budgets: true # Enable computation time budgets
      fallback_to_fast_estimation: true # Use fast estimation when evaluation is skipped

    # Evaluation frequency limits
    frequency_limits:
      max_total_attempts: 3 # Maximum evaluation attempts per compression session
      max_consecutive_failures: 2 # Maximum consecutive failures before skipping
      max_evaluation_time_seconds: 300.0 # Maximum total evaluation time per session
      skip_after_failures: 2 # Skip expensive evaluations after this many failures
      timeout_seconds: 120.0 # Default timeout for individual evaluations

    # Computation time budgets
    time_budget:
      total_budget_seconds: 300.0 # Total time budget for all evaluations
      vmaf_budget_seconds: 180.0 # Time budget for VMAF evaluation
      ssim_budget_seconds: 90.0 # Time budget for SSIM evaluation
      progress_interval_seconds: 5.0 # Interval for progress updates
      graceful_degradation: true # Enable graceful degradation on timeout

    # Result prediction settings
    result_prediction:
      skip_threshold: 0.8 # Confidence threshold for skipping evaluation
      confidence_threshold: 0.7 # Minimum confidence for predictions
      max_historical_results: 100 # Maximum historical results to keep
      enable_content_analysis: true # Enable video content analysis for prediction

      # VMAF prediction model weights
      vmaf_model_weights:
        baseline: 75.0
        resolution_factor: 0.015
        bitrate_factor: 0.008
        complexity_penalty: -15.0
        motion_penalty: -10.0
        fps_factor: 0.1
        codec_bonus: 5.0
        duration_penalty: -0.05

      # SSIM prediction model weights
      ssim_model_weights:
        baseline: 0.92
        resolution_factor: 0.00008
        bitrate_factor: 0.000005
        complexity_penalty: -0.08
        motion_penalty: -0.05
        fps_factor: 0.0005
        codec_bonus: 0.02
        duration_penalty: -0.0001

  # Comprehensive debug logging configuration
  # Theoretical limits: boolean flags (true/false), no numeric constraints
  debug_logging:
    enabled: false # Enable comprehensive debug logging (can be overridden by CLI --debug)
    performance_metrics: false # Enable performance metrics logging
    compression_decisions: true # Log compression parameter decisions and justifications
    fps_reduction_analysis: true # Log detailed FPS reduction analysis and justification
    configuration_loading: true # Log configuration loading and application steps
    parameter_changes: true # Log all parameter changes with reasoning
    session_tracking: true # Enable compression session tracking and summaries

    # Performance logging settings
    performance_logging:
      operation_timing: true # Log timing for major operations
      memory_usage: false # Log memory usage metrics (requires psutil)
      ffmpeg_performance: true # Log FFmpeg execution performance
      quality_evaluation_timing: true # Log quality evaluation performance

    # Decision logging settings
    decision_logging:
      strategy_selection: true # Log compression strategy selection reasoning
      encoder_selection: true # Log encoder selection decisions
      quality_parameter_decisions: true # Log quality parameter (CRF, preset) decisions
      resolution_decisions: true # Log resolution change decisions
      bitrate_calculations: true # Log bitrate calculation steps

    # Configuration logging settings
    config_logging:
      active_values: true # Log active configuration values at start
      overrides_applied: true # Log CLI overrides and their effects
      validation_results: true # Log configuration validation results
      file_changes: true # Log when configuration files are reloaded

    # Session logging settings
    session_logging:
      detailed_summary: true # Log detailed session summaries
      decision_history: true # Track and log decision history
      parameter_evolution: true # Track parameter changes over time
      performance_summary: true # Log performance metrics summary

  # Advanced codec and quality controls
  # Theoretical limits: min_bpp (bits-per-pixel) >= 0.001, size_savings_threshold (0.0-1.0), min_bitrate (kbps) >= encoder minimum, priority list order matters
  codec:
    allow_hevc: true
    allow_h264_high10: true
    priority: [hevc_10bit, hevc_8bit, h264_10bit, h264_8bit]
    final_preset: medium
    tune: animation
    min_bpp:
      h264_8bit: 0.023
      h264_10bit: 0.020
      hevc_8bit: 0.018
      hevc_10bit: 0.015
    # Codec selection strategy
    prefer_hevc_when:
      size_savings_threshold: 0.15 # Prefer HEVC when size savings >15%
      quality_maintained: true # Only if quality is maintained
      min_bitrate: 500 # Minimum bitrate for HEVC consideration

  # FPS policy settings
  # Theoretical limits: low_motion_threshold (0.0-1.0), boolean flags
  fps_policy:
    prefer_24fps_for_low_motion: true
    low_motion_threshold: 0.35

  # Prefilter settings
  # Theoretical limits: filter_strengths (0.0-1.0), boolean flags
  prefilters:
    denoise: true
    deband: true
    sharpen: false # Selective sharpening for content that benefits (disabled by default)
    # Perceptual filter strengths (0.0-1.0)
    filter_strengths:
      denoise:
        high_complexity: 0.8
        medium_complexity: 0.5
        low_complexity: 0.3
      deband:
        high_complexity: 0.6
        medium_complexity: 0.4
        low_complexity: 0.2
      sharpen:
        medium_complexity_low_motion: 0.3
        high_complexity_low_motion: 0.2

  # Quality control settings
  # Theoretical limits: min_target_utilization (0.0-1.0), refine_iterations >= 0, quality_floors (0-100), weights sum should be ~1.0, bitrate_step >= 1.0, max_multiplier >= 1.0
  quality_controls:
    min_target_utilization: 0.92
    refine_iterations: 2
    hybrid_quality_check:
      enabled: true
      single_file_floor: 65 # Out of 100 - reasonable quality for single compressed files
      segment_floors: [70, 60, 50, 45] # Progressive fallback for segments: higher quality expected, but fallback if needed
      weights:
        perceptual_hash: 0.40 # Human-perceivable similarity (most important)
        size_efficiency: 0.20 # How well target size was utilized
        frame_validity: 0.20 # Frames can be decoded without corruption
        technical_validity: 0.20 # Format integrity, duration accuracy
      sampling:
        key_frames: 5 # start, 25%, 50%, 75%, end
        random_frames: 3 # Additional random samples for validation
    uplift:
      enabled: true
      max_passes: 3
      bitrate_step: 1.08 # Smaller steps for precision (reduced from 1.12)
      max_multiplier: 1.35
      quality_aware: true # Enable quality-aware bitrate adjustment based on VMAF/SSIM feedback
      min_quality_improvement: 2.0 # Minimum quality improvement (VMAF/SSIM points) to continue uplift
    on_fail_segment: true
  # Strict size enforcement and near-limit retry
  # Theoretical limits: near_limit_retry_percent (0.0-1.0)
  size_control:
    near_limit_retry_percent: 0.08
  # Segmentation finalize policy (merge into top segmentation block)

  # Profiles for specialized pipelines
  # Theoretical limits: size_limit_mb > 0, audio_kbps_range [min, max] where min <= max and both >= 1, vmaf_threshold (0-100), ssim_threshold (0.0-1.0), bpp_floor >= 0.001, max_passes >= 1, bitrate_step >= 1.0, min_short_side_px >= 64
  profiles:
    discord_10mb:
      size_limit_mb: 10
      audio_kbps_range: [64, 64]
      vmaf_threshold: 80
      vmaf_threshold_low_res: 78 # when eval height <= 480p
      ssim_threshold: 0.94 # Y-channel
      # Bits-per-pixel floors to prevent blockiness (H.264 8-bit)
      bpp_floor:
        low_motion: 0.030
        normal: 0.035
        high_motion: 0.040
      fps_policy:
        prefer_24_for_low_motion: true
      refine:
        max_passes: 3
        bitrate_step: 1.08
        # Encode with a small headroom cushion to ensure final muxed file remains under Discord's 10MB cap
        size_guard_mb: 0.05
        # Maximum tolerance beyond the published limit that we still consider acceptable (Discord requires 0)
        max_over_limit_mb: 0.0
      guardrails:
        min_short_side_px: 480  # If CAE would drop below 480p short side, switch to segmentation
      # x264 two-pass tuning
      x264:
        preset: slow
        tune: film
        gop: 240
        keyint_min: 23
        sc_threshold: 40
        qcomp: 0.65
        aq_mode: 2
        aq_strength: 1.1
        rc_lookahead: 40
        maxrate_multiplier: 1.10
        bufsize_multiplier: 2.0
